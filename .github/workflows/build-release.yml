name: Build and Release

on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  # x86_64 native build on ubuntu-latest (fast)
  build-x86_64:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create directories
        run: mkdir -p logs dist

      - name: Build base image (x86_64 - native)
        run: |
          docker buildx build \
            --builder default \
            --network host \
            --platform linux/amd64 \
            --secret id=github_token,env=GITHUB_TOKEN \
            -f docker/Dockerfile.base \
            -t red_env_build_base:x86_64 \
            --load \
            . 2>&1 | tee logs/build_base_x86_64.log

      - name: Build offline package (x86_64 - native)
        run: |
          docker buildx build \
            --builder default \
            --network host \
            --platform linux/amd64 \
            --secret id=github_token,env=GITHUB_TOKEN \
            --build-arg BASE_IMAGE=red_env_build_base:x86_64 \
            -f docker/Dockerfile.build \
            -t red_env_builder:x86_64 \
            --output type=local,dest=./output_x86_64 \
            . 2>&1 | tee logs/build_x86_64.log
          
          cp output_x86_64/*.tar.gz* dist/

      - name: List build output
        run: ls -lh dist/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: red_env_offline_x86_64
          path: dist/
          retention-days: 7

  # ARM64 native build on ubuntu-latest-arm64
  build-arm64:
    runs-on: ubuntu-latest-arm64
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create directories
        run: mkdir -p logs dist

      - name: Build base image (ARM64 - native)
        run: |
          docker buildx build \
            --builder default \
            --network host \
            --platform linux/arm64 \
            --secret id=github_token,env=GITHUB_TOKEN \
            -f docker/Dockerfile.base \
            -t red_env_build_base:arm64 \
            --load \
            . 2>&1 | tee logs/build_base_arm64.log

      - name: Build offline package (ARM64 - native)
        run: |
          docker buildx build \
            --builder default \
            --network host \
            --platform linux/arm64 \
            --secret id=github_token,env=GITHUB_TOKEN \
            --build-arg BASE_IMAGE=red_env_build_base:arm64 \
            -f docker/Dockerfile.build \
            -t red_env_builder:arm64 \
            --output type=local,dest=./output_arm64 \
            . 2>&1 | tee logs/build_arm64.log
          
          cp output_arm64/*.tar.gz* dist/

      - name: List build output
        run: ls -lh dist/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: red_env_offline_arm64
          path: dist/
          retention-days: 7

  # Verify x86_64
  verify-x86_64:
    needs: build-x86_64
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: red_env_offline_x86_64
          path: dist/

      - name: Create logs directory
        run: mkdir -p logs

      - name: Verify package integrity (x86_64)
        run: |
          echo "=== Files in dist/ ==="
          ls -lh dist/ || echo "dist directory does not exist!"
          
          cd dist
          
          echo "=== Verifying package integrity ==="
          # Extract filename from checksum file and verify
          sha256sum -c red_env_offline_x86_64.tar.gz.sha256 || {
            # If verification fails due to path mismatch, try alternative method
            expected_hash=$(awk '{print $1}' red_env_offline_x86_64.tar.gz.sha256)
            actual_hash=$(sha256sum red_env_offline_x86_64.tar.gz | awk '{print $1}')
            if [ "$expected_hash" = "$actual_hash" ]; then
              echo "✓ Package integrity verified for x86_64!"
            else
              echo "✗ Hash mismatch!"
              exit 1
            fi
          }

      - name: Build verification image (x86_64)
        run: |
          echo "=== Checking required files ==="
          test -f dist/red_env_offline_x86_64.tar.gz || {
            echo "ERROR: dist/red_env_offline_x86_64.tar.gz not found!"
            ls -lh dist/
            exit 1
          }
          
          echo "=== Building verification image ==="
          docker buildx build \
            --builder default \
            --network host \
            --platform linux/amd64 \
            -f docker/Dockerfile.verify \
            -t red_env_verify:x86_64 \
            --build-arg PACKAGE_FILE=red_env_offline_x86_64.tar.gz \
            --load \
            . 2>&1 | tee logs/verify_x86_64_build.log

      - name: Verify complete (x86_64)
        run: echo "✓ Verification passed for x86_64!"

  # Verify ARM64
  verify-arm64:
    needs: build-arm64
    runs-on: ubuntu-latest-arm64
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: red_env_offline_arm64
          path: dist/

      - name: Create logs directory
        run: mkdir -p logs

      - name: Verify package integrity (ARM64)
        run: |
          echo "=== Files in dist/ ==="
          ls -lh dist/ || echo "dist directory does not exist!"
          
          cd dist
          
          echo "=== Verifying package integrity ==="
          # Extract filename from checksum file and verify
          sha256sum -c red_env_offline_arm64.tar.gz.sha256 || {
            # If verification fails due to path mismatch, try alternative method
            expected_hash=$(awk '{print $1}' red_env_offline_arm64.tar.gz.sha256)
            actual_hash=$(sha256sum red_env_offline_arm64.tar.gz | awk '{print $1}')
            if [ "$expected_hash" = "$actual_hash" ]; then
              echo "✓ Package integrity verified for ARM64!"
            else
              echo "✗ Hash mismatch!"
              exit 1
            fi
          }

      - name: Build verification image (ARM64)
        run: |
          echo "=== Checking required files ==="
          test -f dist/red_env_offline_arm64.tar.gz || {
            echo "ERROR: dist/red_env_offline_arm64.tar.gz not found!"
            ls -lh dist/
            exit 1
          }
          
          echo "=== Building verification image ==="
          docker buildx build \
            --builder default \
            --network host \
            --platform linux/arm64 \
            -f docker/Dockerfile.verify \
            -t red_env_verify:arm64 \
            --build-arg PACKAGE_FILE=red_env_offline_arm64.tar.gz \
            --load \
            . 2>&1 | tee logs/verify_arm64_build.log

      - name: Verify complete (ARM64)
        run: echo "✓ Verification passed for ARM64!"

  release:
    needs: [verify-x86_64, verify-arm64]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release_artifacts

      - name: Prepare release files
        run: |
          echo "=== Downloaded artifacts structure ===\"
          find release_artifacts -type f | head -20
          
          mkdir -p release_files
          find release_artifacts -type f \( -name "*.tar.gz" -o -name "*.sha256" \) -exec cp {} release_files/ \;
          
          echo "=== Final release files ===\"
          ls -lh release_files/
          
          if [ -z "$(ls -A release_files/)" ]; then
            echo "ERROR: No release files found!"
            exit 1
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release_files/*
          draft: false
          prerelease: false
          body: |
            ## Red Environment Release ${{ github.ref_name }}
            
            This release includes offline installation packages.
            
            ### Available Packages
            
            - **x86_64**: `red_env_offline_x86_64.tar.gz` (native build)
            - **ARM64**: `red_env_offline_arm64.tar.gz` (if included)
            
            ### Installation Instructions
            
            ```bash
            # Download the package for your architecture
            tar -xzf red_env_offline_<arch>.tar.gz -C ~/red_env_offline
            
            # Navigate and install
            cd ~/red_env_offline
            ./install.sh
            ```
            
            ### Verify Package Integrity
            
            ```bash
            sha256sum -c red_env_offline_<arch>.tar.gz.sha256
            ```
            
            ### Build Information
            
            - **Commit**: ${{ github.sha }}
            - **Actor**: ${{ github.actor }}
            - **Build Date**: ${{ github.event.head_commit.timestamp }}

